<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layoutBase}">

<th:block layout:fragment="content">

    <style>
    .form-control2 {
      /* display: block; */
      /* width: 100%; */
      max-width: 200px;
      height: calc(1.5em + 0.5rem + 2px);
      padding: 0.375rem 0.5rem;
      font-size: small;
      font-weight: 400;
      line-height: 1.5;
      color: #6e707e;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #d1d3e2;
      border-radius: 0.35rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .swiper {
      width: 100%;
      height: 100%;
    }

    .swiper-slide {
      text-align: center;
      font-size: 18px;
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }


    </style>

    <div class="row">
        <!-- 왼쪽 -->
        <div class="col-4">
            <div class="card shadow mb-4">
                <a href="#loan" class="d-block card-header py-3" data-toggle="collapse" role="button" aria-expanded="true">
                    <h6 class="m-0 font-weight-bold text-primary">대출 신청 정보</h6>
                </a>

                <div class="card-body p-2 collapse show" id="loan">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <tr><td>번호</td>
                                    <td><span th:text="${loanSeq}"></span>
                                        <input type="hidden" id="loanSeq" th:value="${loanSeq}">
                                    </td>
                                </tr>
                                <tr>
                                    <td>총 대출 금액</td>
                                    <td class="row mx-0">
                                        <input type="number" step="0" class="form-control" style="width:30%; display:inline"  id="totalLoanAmount" oninput="formattingNumber(this)" />
                                        <span style="height:20px; margin-top:5px;">
                                            <strong>&nbsp; / 분할모집 실행 여부 &nbsp;</strong><input type="checkbox" id="splitYn" value="Y"/>
                                            <strong>&nbsp; / 재모집 여부 &nbsp;</strong><input type="checkbox" id="reOpenYn" value="Y"/>
                                        </span>
                                    </td>
                                </tr>

                                <tr>
                                    <td>KB시세</td>
                                    <td class="row mx-0" id="marketPrice">
                                        0
                                    </td>
                                </tr>

                                <tr>
                                    <td>LTV</td>
                                    <td class="row mx-0">
                                        <input type="number" class="form-control" style="width:30%; display:inline"  id="ltv"  />
                                    </td>
                                </tr>

                                <tr>
                                    <td>담보선택</td>
                                    <td class="row mx-0">
                                        <input type="button" value="담보선택" id="btnCollateral" />
                                        <input type="hidden" id="collateralId" th:value="${param.collateralId}" >
                                    </td>
                                </tr>

                                <tr>
                                    <td>KB아파트 코드</td>
                                    <td class="row mx-0">
                                        <input type="text" step="0" class="form-control col-5" id="aptCode"  />
                                    </td>
                                </tr>

                                <tr>
                                    <td>아파트면적번호</td>
                                    <td class="row mx-0">
                                        <input type="text" step="0" class="form-control col-5" id="areaCode" />
                                    </td>
                                </tr>

                                <tr>
                                    <td>대출기간 개월</td>
                                    <td class="row mx-0">
                                        <input type="number" step="0" class="form-control col-5" id="loanPeriodMonth" value="36" />
                                    </td>
                                </tr>

                                <tr>
                                    <td>대출기간</td>
                                    <td>
                                        <input type="date"  id="loanStartDay" class="form-control2"  >
                                        ~
                                        <input type="date"  id="loanExpireDay" class="form-control2"  ><BR><BR>
                                        <strong>시작일 변경불가 &nbsp;</strong><input type="checkbox" id="fixedStartYn" value="Y"/>
                                        <strong>&nbsp; / 이자-상환 같은달 실행여부 &nbsp;</strong><input type="checkbox" id="sameMonthYn" value="Y"/>
                                    </td>
                                </tr>

                                <tr>
                                    <td>이자지급일</td>
                                    <td>매달 <input type="number" class="form-control col-3" style="display:inline; width:50px;" id="interestPaymentDay" value="15" placeholder="15" /> 일</td>
                                </tr>

                                <tr>
                                    <td>기본금리</td>
                                    <td><input type="number" class="form-control col-3" style="display:inline;  " id="interestRate" value="3.0" placeholder="3.0" />%</td>
                                </tr>

                                <tr>
                                    <td>만기시 최고 금리</td>
                                    <td><input type="number" class="form-control col-3" style="display:inline" id="maxInterestRate" value="21.0" placeholder="21.0" />%</td>
                                </tr>

                                <tr>
                                    <td>연체금리</td>
                                    <td><input type="number" class="form-control col-3" style="display:inline" id="overdueInterestRate" value="5.0" placeholder="5.0"  />%</td>
                                </tr>

                                <tr>
                                    <td>낙찰가율</td>
                                    <td><input type="number" class="form-control col-3" style="display:inline" id="bidRate" value="73.5" placeholder="73.5" />%</td>
                                </tr>

                                <tr>
                                    <td>차입자 정보 조회일시</td>
                                    <td>
                                        <input type="text" class="form-control" style="width:30%; display:inline" id="borrowerInfoDate" value="23년 6월 3일" placeholder="23년 6월 3일" />
                                        <input type="button" value="차입자 정보 상세" id="userDetail">
                                    </td>
                                </tr>


                                <tr>
                                    <td>차입자 ID</td>
                                    <td>
                                        <input type="text" id="userId" class="form-control col-5" readonly />
                                    </td>
                                </tr>

                                <tr>
                                    <td>상환가상계좌 정보</td>
                                    <td>
                                        <input type="text" class="form-control col-5" style="display:inline" id="vtAccountNo" readonly /><br>
                                        <input type="hidden" id="loanStatus" /><br>
                                        <span style="font-color:red; font-size:10px;"> ※ 금결원 계약신고시 생성됩니다.</span>
                                    </td>
                                </tr>


                            </table>
                        </div>

                    <div class="d-block col-12 align-self-center">
                        <button class="w-100 btn btn-primary btn-lg m-1 col-3" id="loanSave">저장(수정)</button>

                        <button class="w-100 btn btn-default btn-lg m-1 col-3" id="repayment">상환스케줄</button>
                    </div>
                    <hr />
                </div>
            </div>

        </div>

        <!-- 오른쪽 -->
        <div class="col-5">
            <div class="card shadow mb-4">
                <a href="#collateral" class="d-block card-header py-3" data-toggle="collapse" role="button" aria-expanded="true">
                    <h6 class="m-0 font-weight-bold text-primary">대출 상세정보</h6>
                </a>

                <div class="card-body p-2 collapse show" id="collateral">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <tr><td>자가여부</td>
                                <td><input type="text" class="form-control" id="selfYn" value="Y" /></td>
                            </tr>
                            <tr><td>채권순위</td>
                                <td><input type="text" class="form-control" id="orderOfBond" value="1" /></td>
                            </tr>
                            <tr><td>자금 사용처</td>
                                <td><input type="text" class="form-control" id="loanUsage" value="대출" /></td>
                            </tr>
                            <tr><td>선순위 대출잔액</td>
                                <td><input type="text" class="form-control" id="priorityLoanAmount"  value="100000000"/></td>
                            </tr>
                            <tr><td>기타 우선변제금</td>
                                <td><input type="text" class="form-control" id="etcLoanAmount"  value="100000000" /></td>
                            </tr>
                            <tr><td>선순위 채권최고액</td>
                                <td><input type="text" class="form-control" id="priorityBondMaxAmount" value="100000000" /></td>
                            </tr>
                            <tr><td>대출한도 예외 설정 근거</td>
                                <td><input type="text" class="form-control" id="limitCheckNote" value="CHECK" /></td>
                            </tr>
                            <tr><td>상환방식</td>
                                <td><input type="text" class="form-control" id="repaymentMethod" value="MATURITY" /></td>
                            </tr>
<!--                            <tr><td>예상대출 실행일</td>-->
<!--                                <td><input type="Date" class="form-control" id="expectExecutionDate" value="" /></td>-->
<!--                            </tr>-->
                            <tr><td>수수료</td>
                                <td><input type="text" class="form-control" id="loanFeeAmount" value="3000000" /></td>
                            </tr>
                            <tr><td>비용</td>
                                <td><input type="text" class="form-control" id="costAmount" value="0" /></td>
                            </tr>
                            <tr><td>채권최고액 설정비율</td>
                                <td><input type="text" class="form-control" id="bondMaxLimitRatio" value="0.27" /></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>


            <div class="card shadow mb-4">
                <a href="#collateral" class="d-block card-header py-3" data-toggle="collapse" role="button" aria-expanded="true">
                    <h6 class="m-0 font-weight-bold text-primary">증빙자료</h6>
                </a>

                <div class="card-body p-2 collapse show" id="attachFile">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <tr>
                                <td>
                                    등기부등본 사본(모집중)
                                </td>
                                <td>
                                    <Form id="fileFormBefore" >
                                        <input type="file" name="file"> <input type="button" class="attachFile" data-fileid="Before" value="파일업로드">
                                    </Form>
                                    <input type="text" class="form-control" id="attachFileBefore" value="" />
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    등기부등본 사본(모집후)
                                </td>
                                <td>
                                    <Form id="fileFormAfter" >
                                        <input type="file" name="file"> <input type="button" class="attachFile" data-fileid="After"  value="파일업로드">
                                    </Form>
                                    <input type="text" class="form-control" id="attachFileAfter" value="" />
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>


            <div class="card shadow mb-4">
                <a href="#loanReceiveAccount" class="d-block card-header py-3" data-toggle="collapse" role="button" aria-expanded="true">
                    <h6 class="m-0 font-weight-bold text-primary display:inline-block">대출입금계좌 </h6>
                </a>
                <div class="card-body p-2 collapse show" id="loanReceiveAccount">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0" id="accountTb">
                            <tr >
                                <th style="align:center;">은행명</th>
                                <th style="align:center;">계좌번호</th>
                                <th style="align:center;">예금주명</th>
                                <th style="align:center;">받을 금액</th>
                                <th style="align:center;"><input type="button" id="addAccount" value="계좌추가" >
                                    <input type="button" id="emptyAccount" value="초기화" ></th>
                            </tr>
                            <tbody>
                                <tr>
                                    <td><input type="text" name="bankCode"></td>
                                    <td><input type="text" name="accountNo"></td>
                                    <td><input type="text" name="bankUserName"></td>
                                    <td><input type="text" name="amount"></td>
                                    <td><input type="button" class="checkAccount" value="예금주 확인"></td>
                                </tr>
                            </tbody>
                        </table>

                        <button class="w-100 btn btn-success btn-sm m-1 col-3"  id="saveLoanAccount">계좌내역 저장</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- 오른쪽 -->
        <div class="col-3">

            <div class="card shadow mb-4">

                <a href="#p2pcenter" class="d-block card-header py-3" data-toggle="collapse" role="button" aria-expanded="true">
                    <h6 class="m-0 font-weight-bold text-primary">금결원 신고</h6>
                </a>

                <div class="card-body p-2" id="p2pcenter">
                    <div class="d-block col-12 align-self-center">
                        <select id="p2pRegist">
                            <option value="REG_CENTER">대출신청</option>
                            <option value="REG_CANCEL">신청취소</option>
                            <option value="REG_CONTRACT">대출계약생성 - 투자모집 완료이후</option>
                        </select>
                        <button class="w-100 btn btn-success btn-sm m-1 col-3"  id="p2pAction">실행</button>
                    </div>
                </div>
             </div>

            <div class="card shadow mb-4">

                <a href="#note" class="d-block card-header py-3" data-toggle="collapse" role="button" aria-expanded="true">
                    <h6 class="m-0 font-weight-bold text-primary">변경노트</h6>
                </a>

                <div class="card-body p-2">

                    <div class="col-12 mb-2">
                        <label for="memo">메모</label>
                        <textarea id="memo"  class="form-control" style="min-height: 10vh"></textarea>
                    </div>

                    <div class="d-block col-12 align-self-center">
                        <select id="status">
                            <option value="">메모작성</option>
                            <option value="AUDIT">심사중으로 상태변경</option>
                            <option value="APPROVAL">승인으로 상태변경</option>
                            <option value="REJECT">거절로 상태변경</option>
                        </select>
                        <button class="w-100 btn btn-success btn-sm m-1 col-3"  id="changeState">실행</button>
                    </div>

                </div>
                <hr>
                <div class="card-body p-2 collapse show" id="note">
                </div>
            </div>

        </div>
    </div>

    <hr />

    <div class="modal" id="modal"  role="dialog" aria-labelledby="remoteModalLabel"  >
        <div class="modal-dialog" style="width:80%; max-width:800px;">
            <div class="modal-content" >
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">차입자 신용정보</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        X
                    </button>
                </div>

                <div class="modal-body">
                    <div class="jarviswidget jarviswidget-color-blueDark"
                         id="wid-id-4" data-widget-editbutton="false"
                         data-widget-colorbutton="false"
                         data-widget-deletebutton="false"
                         data-widget-togglebutton="false">
                        <div role="content">
                            <div class="widget-body">
                                <input type="button" value="데이터 추가" id="appendTr">
                                <table class="table table-bordered" id="loaner">
                                    <tbody>
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="btn_save">저장</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal" id="modal2"  role="dialog" aria-labelledby="remoteModalLabel"  >
        <div class="modal-dialog" style="width:80%; max-width:800px;">
            <div class="modal-content" >
                <div class="modal-header">
                    <h4 class="modal-title" id="test1">상환 스케줄</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        X
                    </button>
                </div>

                <div class="modal-body">
                    <div class="swiper">
                        <!-- Additional required wrapper -->
                        <div class="swiper-wrapper">

                        </div>
                        <!-- If we need pagination -->
                        <div class="swiper-pagination"></div>

                        <!-- If we need navigation buttons -->
                        <div class="swiper-button-prev"></div>
                        <div class="swiper-button-next"></div>

                        <!-- If we need scrollbar -->
                        <div class="swiper-scrollbar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        $("#addAccount").on("click", function() {
            console.log("table append");
            var tr = '<tr>'+
                     '   <td><input type="text" name="bankCode"></td>'+
                     '   <td><input type="text" name="accountNo"></td>'+
                     '   <td><input type="text" name="bankUserName"></td>'+
                     '   <td><input type="text" name="amount"></td>'+
                     '   <td><input type="button" class="checkAccount" value="예금주 확인"></td>'+
                     '</tr>'
            $("#accountTb > tbody:last").append(tr);
        });

        $("#emptyAccount").on("click", function() {
            $("#accountTb > tbody:last").empty();
        });



        $("body").on("click", ".checkAccount",  function() {

            var target = $(this).parent().parent();

            var temp = {};
            var bankUserName = "";
            $(target).find("input").each(function(i, obj){
                temp[obj.name] = obj.value;
                if(obj.name == "bankUserName") bankUserName = obj;
            });

            console.log(bankUserName);

            // 계좌명 확인하자
            $.ajax({
                url : "/proxy/grayzip/v1/invest/checkAccountName?bankCode="+temp["bankCode"]+"&accountNo="+temp["accountNo"],
                type: 'get',
                cache : false,
                contentType: false,
                processData: false,
                success : function(data) {
                    $(bankUserName).val(data.bankUserName);
                }
            });
        });


       $("#saveLoanAccount").on("click", function() {
            var bankAccountList = [];
            $("#accountTb > tbody:last > tr").each(function(i, obj) {
                var temp = {};

                $(obj).find("input").each(function(i, obj){

                    temp[obj.name] = obj.value;
                });

                temp["loanSeq"] = $("#loanSeq").val();
                bankAccountList.push(temp)
            });

            $.ajax({
                url : "/proxy/grayzip/v1/loan/loanAccount",
                type: 'POST',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify(bankAccountList),
                cache : false,
                success : function(data) {
                    alert("저장되었습니다.");
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    alert("저장시 오류가 발생했습니다.");
                }
            });

       });







        $(".attachFile").on("click", function(event) {
            event.preventDefault();

            var fileFormId = $(this).data("fileid");
            var formData = new FormData($("#fileForm"+fileFormId)[0]);

            $.ajax({
                url : "https://api-gw.dozip.kr/common/v1/attachFile",
                type: 'post',
                data : formData,
                cache : false,
                contentType: false,
                processData: false,
                success : function(attachs, jqXHR, textStatus) {
                    console.log(attachs);

                    $("#attachFile"+fileFormId).val(attachs[0].filePath);
                    saveAttach(fileFormId);
                }
            });

       });

       function getAttach() {
            $.ajax({
                url : "/proxy/grayzip/v1/loan/loanAttr?loanSeq="+$("#loanSeq").val()+"&attrGroup=attested",
                type: 'GET',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                cache : false,
                success : function(data) {
                    console.log(data);
                    $("#attachFileAfter").val(data.after);
                    $("#attachFileBefore").val(data.before);
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    basicInfo();
                }
            });
       }


       function saveAttach() {

            var attachInfo = [
                {
                    "id" : {
                        "loanSeq" : $("#loanSeq").val(),
                        "attrGroup" : "attested",
                        "attrKey": "before"
                    },
                    "attrValue": $("#attachFileBefore").val(),
                    "attrOrder": "1"
                },
                {
                    "id" : {
                        "loanSeq" : $("#loanSeq").val(),
                        "attrGroup" : "attested",
                        "attrKey": "after"
                    },
                    "attrValue": $("#attachFileAfter").val(),
                    "attrOrder": "2"
                }
            ];

            $.ajax({
                url : "/proxy/grayzip/v1/loan/loanAttr",
                type: 'PUT',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify(attachInfo),
                cache : false,
                success : function(data) {
                    alert("저장되었습니다.");
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    alert("저장시 오류가 발생했습니다.");
                }
            });
        }

        $("#appendTr").on("click", function() {

        });

        $("body").on("click", ".delRow", function() {
            console.log("click");
            $(this).parent().parent().remove();
        });


        $("#userDetail").on("click", function() {
                $("#loaner > tbody").empty();
                var loanSeq = $("#loanSeq").val();

                if(loanSeq == 0) {
                    alert("대출 등록 완료 후 작성가능합니다.");
                    return;
                }


                $.ajax({
                    url : "/proxy/grayzip/v1/loan/loanAttr?loanSeq="+$("#loanSeq").val()+"&attrGroup=loaner",
                    type: 'GET',
                    accept: "application/json",
                    contentType: "application/json; charset=utf-8",
                    cache : false,
                    success : function(data) {
                        console.log(data);
                        var temp = 1;

                        if(Object.keys(data).length == 0) {
                            basicInfo()
                        } else {
                            Object.keys(data).forEach(function(key){
                                var tr = '<tr id="loanerRw'+temp+'">'+
                                        '<td>'+
                                        '    <input type="text" name="key" value="'+key+'" class="form-control " >'+
                                        '</td>'+
                                        '<td>'+
                                        '    <input type="text" name="value" value="'+data[key]+'" class="form-control col-5" >'+
                                        '</td>'+
                                        '<td>'+
                                        '    <input type="button" value="삭제" class="form-control col-5 delRow" >'+
                                        '</td>'+
                                        '</tr>';
                                temp++;
                                $("#loaner tbody").append(tr);
                            });
                        }
                        $("#modal").modal("show");
                    },
                    error: function(request, error) {
                        console.log(request);
                        console.log(error);
                        basicInfo();
                    }
                });
        });

        function basicInfo() {

            var keysList = ["1년내 연체이력","개인파산/회생 등","나이/성별","당사 연계대출 잔액",
                            "소득형태","신용점수","신용카드 총한도","연소득","온투업 연계대출 누적 상환금액",
                            "온투업 연계대출 잔액","월평균 카드 사용액","채무불이행","체납세금","총 채무액"];
            var temp = 1;
            keysList.forEach(function(key) {
                var tr = '<tr id="loanerRw'+temp+'">'+
                            '<td>'+
                            '    <input type="text" name="key" value="'+key+'" class="form-control " >'+
                            '</td>'+
                            '<td>'+
                            '    <input type="text" name="value" value="" class="form-control col-5" >'+
                            '</td>'+
                            '<td>'+
                            '    <input type="button" value="삭제" class="form-control col-5 delRow" >'+
                            '</td>'+
                            '</tr>';
                    temp++;
                    $("#loaner tbody").append(tr);
            });
            $("#modal").modal("show");
        }

        function init() {
            var loanSeq = $("#loanSeq").val();

            if( loanSeq != "" && loanSeq>0) {
                getLoan(loanSeq);
                getAccount(loanSeq);
            } else {
                newLoan($("#collateralId").val());
            }
        }

        init();


        function getAccount(loanId) {
             $("#accountTb > tbody:last").empty();

             $.ajax({
                url : "/proxy/grayzip/v1/loan/loanAccount/"+loanId,
                type: 'GET',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                cache : false,
                success : function(data) {
                    data.forEach(function(account) {

                        console.log("table append");
                        var tr = '<tr>'+
                                 '   <td><input type="text" name="bankCode" value="'+account.bankCode+'" ></td>'+
                                 '   <td><input type="text" name="accountNo" value="'+account.accountNo+'"></td>'+
                                 '   <td><input type="text" name="bankUserName" value="'+account.bankUserName+'"></td>'+
                                 '   <td><input type="text" name="amount" value="'+account.amount+'"></td>'+
                                 '   <td><input type="button" class="checkAccount" value="예금주 확인"></td>'+
                                 '</tr>'
                        $("#accountTb > tbody:last").append(tr);

                    });
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    alert("계좌 조회중 오류가 발생했습니다.");
                }
             });
        }




        function getLoan(loanId) {
            $.ajax({
                url : "/proxy/grayzip/v1/loan/"+loanId,
                type: 'GET',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                cache : false,
                success : function(data) {
                    console.log(JSON.stringify(data, null, 4));

                    getMarketPrice(data.collateralId);

                    console.log("xxxx");
                    getAttach();
                    console.log("xxxx");

                    $("#loanStatus").val(data["status"]);

                    Object.keys(data).forEach(function(key){
                        if(typeof data[key] != "object") {
                            if($("#"+key).attr("type") == 'date') {
                                $("#"+key).val(data[key].split("T")[0]);
                            }else if($("#"+key).attr("type") == 'checkbox') {
                                if(data[key] == 'Y') $("#"+key).attr("checked", "checked");
                            } else {
                                $("#"+key).val(data[key]);
                            }
                        } else {
                            try {
                                var detail = data[key];
                                Object.keys(detail).forEach(function(key2) {
                                    console.log(key2);
                                    $("#"+key2).val(detail[key2])
                                });
                            } catch(err) {}
                        }
                    });
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    alert("담보 정보를 가져오는 중에 오류가 발생했습니다.");
                }
            });
        }

        function getMarketPrice(collateralId) {
            $.ajax({
                url : "/proxy/grayzip/v1/collaterals/"+collateralId,
                type: 'GET',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                cache : false,
                success : function(data) {
                    console.log(data);
                    $("#marketPrice").text(data.collateralObjectDto.baseMarketPrice);
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    alert("담보 정보를 가져오는 중에 오류가 발생했습니다.");
                }
            });
        }

        function newLoan(collateralId) {
            $.ajax({
                url : "/proxy/grayzip/v1/collaterals/"+collateralId,
                type: 'GET',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                cache : false,
                success : function(data) {
                    console.log(data);
                    $("#aptCode").val(data.collateralObjectDto.aptCode);
                    $("#areaCode").val(data.collateralObjectDto.areaCode);
                    $("#totalLoanAmount").val(data.loanAppliedAmount);
                    $("#marketPrice").text(data.collateralObjectDto.baseMarketPrice);
                    $("#userId").val(data.userId);
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    alert("담보 정보를 가져오는 중에 오류가 발생했습니다.");
                }
            });
        }

        $("#loanSave").on("click", function() {

          if($("#loanStatus").val() == "") $("#loanStatus").val("REG");

           var loanInfo = {
                  "collateralId"       : $("#collateralId").val(),
                  "aptCode"            : $("#aptCode").val(),
                  "areaCode"           : $("#areaCode").val(),
                  "totalLoanAmount"    : $("#totalLoanAmount").val(),
                  "splitYn"            : $("#splitYn").is(":checked") ? "Y" : "N",

                  "sameMonthYn"      : $("#sameMonthYn").is(":checked") ? "Y" : "N",
                  "fixedStartYn"     : $("#fixedStartYn").is(":checked") ? "Y" : "N",
                  "reOpenYn"         : $("#reOpenYn").is(":checked") ? "Y" : "N",

                  "loanPeriodMonth"    : $("#loanPeriodMonth").val(),
                  "ltv"                : $("#ltv").val(),
                  "interestRate"       : $("#interestRate").val(),
                  "maxInterestRate"    : $("#maxInterestRate").val(),
                  "overdueInterestRate": $("#overdueInterestRate").val(),
                  "bidRate"            : $("#bidRate").val(),
                  "loanStartDay"      : $("#loanStartDay").val(),
                  "loanExpireDay"      : $("#loanExpireDay").val(),
                  "interestPaymentDay" : $("#interestPaymentDay").val(),
                  "borrowerInfoDate"   : $("#borrowerInfoDate").val(),
                  "userId"             : $("#userId").val(),
                  "vtAccountNo"        : $("#vtAccountNo").val(),
                  "status"             : $("#loanStatus").val(),
                  "loanDetail": {
                    "selfYn"            : $("#selfYn").val(),
                    "orderOfBond"       : $("#orderOfBond").val(),
                    "loanUsage"         : $("#loanUsage").val(),
                    "priorityLoanAmount": $("#priorityLoanAmount").val(),
                    "etcLoanAmount"     : $("#etcLoanAmount").val(),
                    "priorityBondMaxAmount": $("#priorityBondMaxAmount").val(),
                    "limitCheckNote"     : $("#limitCheckNote").val(),
                    "repaymentMethod"    : $("#repaymentMethod").val(),
                    "expectExecutionDate": $("#expectExecutionDate").val(),
                    "loanFeeAmount"      : $("#loanFeeAmount").val(),
                    "costAmount"         : $("#costAmount").val(),
                    "bondMaxLimitRatio"  : $("#bondMaxLimitRatio").val(),
                  }
                }

           var loanSeq = $("#loanSeq").val();

           if(loanSeq > 0) {
                loanInfo["loanSeq"] = loanSeq;
                loanInfo.loanDetail["loanSeq"] = loanSeq;
           }

           console.log(JSON.stringify(loanInfo, null, 4));

            $.ajax({
                url : "/proxy/grayzip/v1/loan/",
                type: 'post',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify(loanInfo),
                cache : false,
                success : function(data) {
                    alert("저장되었습니다.");
                    getLoan(data.loanSeq);
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                }
            });

        });

        $("#p2pAction").on("click", function() {
             var status = $("#p2pRegist").val();

             var memoLog = {
                    "serviceType" : "LOAN",
                    "serviceId" : $("#loanSeq").val(),
                    status : status
             };

            $.ajax({
                url : "/proxy/grayzip/v1/common/state",
                type: 'post',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify(memoLog),
                cache : false,
                success : function(data) {
                    alert("저장되었습니다.");
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    // alert("저장시 오류가 발생했습니다.");
                }
            });
        });


        $("#changeState").on("click", function() {
             var status = $("#status").val();

             var memoLog = {
                    "serviceType" : "LOAN",
                    "serviceId" : $("#loanSeq").val(),
                    "memo" :  $("#memo").val()
             };

             if(status !="")
                memoLog["status"] = status;

            $.ajax({
                url : "/proxy/grayzip/v1/common/state",
                type: 'post',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify(memoLog),
                cache : false,
                success : function(data) {
                    alert("저장되었습니다.");
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    //alert("저장시 오류가 발생했습니다.");
                }
            });
        });

         $.ajax({
            url : "/proxy/grayzip/v1/common/state?serviceType=LOAN&serviceId="+$("#loanSeq").val(),
            type: 'get',
            accept: "application/json",
            contentType: "application/json; charset=utf-8",
            cache : false,
            success : function(data) {
                data.content.forEach(function(content) {
                    var card = '<div class="card-body p-2 collapse show">' +
                               '<span>'+content.createdAt+'</span> / <span>'+content.employId+'</span>' +
                               '<div class="form-group" style="height:80px;boarder:1px solid red; background-color:#f0f0f0; margin-top:10px;padding:10px;">' +
                               ''+content.memo+''+
                               '</div>'+
                               '</div>';
                    $("#note").append(card);
                });
            },
            error: function(request, error) {
                console.log(request);
                console.log(error);
            }
        });

        $("#appendTr").on("click", function() {

            var tr = '<tr>'+
                            '<td>'+
                            '    <input type="text" name="key" class="form-control " >'+
                            '</td>'+
                            '<td>'+
                            '    <input type="text" name="value"  class="form-control col-5" >'+
                            '</td>'+
                            '<td>'+
                            '    <input type="button" value="삭제" class="form-control col-5 delRow" >'+
                            '</td>'+
                            '</tr>';

           $("#loaner tbody").append(tr);

        });

        $("#btn_save").on("click", function() {

            var loanAttr = [];
            var loanSeq = $("#loanSeq").val();

            $("#loaner tr").each(function(idx, tr) {
                var loaner = {
                    "id" : {
                        "loanSeq" : loanSeq,
                        "attrGroup" : "loaner",
                        "attrKey" : ""
                    },
                    "attrValue": "",
                    "attrOrder": ""
                };
                loaner.id.attrKey = $(tr).find('[name^="key"]').val();
                loaner.attrValue = $(tr).find('[name^="value"]').val();
                loaner.attrOrder = idx;
                loanAttr.push(loaner);
            });

            $.ajax({
                url : "/proxy/grayzip/v1/loan/loanAttr",
                type: 'put',
                accept: "application/json",
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify(loanAttr),
                cache : false,
                success : function(data) {
                    alert("저장되었습니다.");
                    location.reload();
                },
                error: function(request, error) {
                    console.log(request);
                    console.log(error);
                    alert(request.responseJSON.message);
                    //alert("저장시 오류가 발생했습니다.");
                }
            });

        })



        $("#repayment").on("click", function() {
            $.ajax({
                url : "/proxy/grayzip/v1/loan/refund/"+$("#loanSeq").val(),
                type: 'GET',
                cache : false,
                contentType: false,
                processData: false,
                success : function(data) {
                    data.content.forEach(function(repayment) {
                        var tr = '<div class="swiper-slide">'+
                                 '<table class="table table-bordered mb-0">'+
                                 '   <tr><td>회차 </td><td>'+repayment.stepCnt+'</td></tr>'+
                                 '   <tr><td>이자 </td><td>'+repayment.repaymentAmount+'</td></tr>'+
                                 '   <tr><td>원금 </td><td>'+repayment.originAmount+'</td></tr>'+
                                 '   <tr><td>날짜 </td><td>'+repayment.expectDate+'</td></tr>'+
                                 '</table>'+
                                 '</div>';
                        $(".swiper-wrapper").append(tr);
                    });
                    const swiper = new Swiper('.swiper',{});
                    $("#modal2").modal("show");
                }
            });
        });
    </script>


</th:block>
